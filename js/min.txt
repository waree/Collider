!function(){function i(){y||b||(g.clearRect(0,0,c.height,c.width),v.drawBoardBalls(),window.requestAnimationFrame(i))}function r(){v=new e($("#board").width()<400?7:10),b=!0,y=!1,help=!1,d.width=d.height=c.height=c.width=60*(v.gridSize+4),$("#hp").css("width","100%").removeClass("progress-bar-danger progress-bar-warning").addClass("progress-bar-success"),x=60*(v.gridSize+4)/$("#board").height(),v.drawBoard(),v.initBorderBalls(),v.initBoardBalls(),v.drawBoardBalls()}function t(i,r){return Math.floor(Math.random()*(r-i+1)+i)}function o(){return v.hp>0?(v.hp-=1+.5*Math.floor(v.points/5e3),$("#hp").css("width",v.hp+"%"),v.hp<=30&&$("#hp").hasClass("progress-bar-danger")?$("#hp").removeClass("progress-bar-warning progress-bar-success").addClass("progress-bar-danger"):v.hp>30&&v.hp<=60&&$("#hp").hasClass("progress-bar-warning")?$("#hp").removeClass("progress-bar-danger progress-bar-success").addClass("progress-bar-warning"):v.hp>60&&$("#hp").hasClass("progress-bar-success")&&$("#hp").removeClass("progress-bar-danger progress-bar-warning").addClass("progress-bar-success"),void v.checkGameOver()):void v.GameOver()}function e(r){this.gridSize=r,this.points=0,this.hp=100,this.combo=0,this.enaclick=!0,this.speed=r+5,this.fps=60,this.GameOver=function(){$("#newgame-popup").show(500),y=!0,this.enaclick=!1,clearInterval(z),window.cancelAnimationFrame(i)},this.spawn=function(){this.enaclick=!1;for(var i=t(3,this.gridSize-2),r=t(3,this.gridSize-2);"transparent"!=A[i][r].color;)i=t(3,this.gridSize-2),r=t(3,this.gridSize-2);A[i][r].set(M[Math.floor(Math.random()*M.length)],30+60*i,30+60*r),A[i][r].r=30,this.checkCombo()},this.checkGameOver=function(){var i,r,t=0;for(i=2;i<=this.gridSize+1;i++)for(r=2;r<=this.gridSize+1;r++)"transparent"==A[i][r].color&&t++;for(t==this.gridSize*this.gridSize&&(this.points+=100*this.hp,this.initBoardBalls()),t=0,i=2;i<this.gridSize+1;i++)"transparent"==A[i][2].color&&t++,"transparent"==A[i][this.gridSize+1].color&&t++,"transparent"==A[2][i].color&&t++,"transparent"==A[this.gridSize+1][i].color&&t++;0==t&&this.GameOver()},this.drawBoardBalls=function(){for(var i=0;i<this.gridSize+4;i++)for(var r=0;r<this.gridSize+4;r++)"transparent"!=A[i][r].color&&(A[i][r].s&&A[i][r].shrink(i,r),""!=A[i][r].d&&A[i][r].move(),A[i][r].draw())},this.initBorderBalls=function(){var i,r;for(i=0;i<this.gridSize+4;i++)for(A[i]=new Array,r=0;r<this.gridSize+4;r++)A[i].push(new s);for(i=0;i<this.gridSize;i++)A[i+2][1].set(M[Math.floor(Math.random()*M.length)],30+60*(i+2),90),A[i+2][0].set(M[Math.floor(Math.random()*M.length)],30+60*(i+2),30),A[this.gridSize+2][i+2].set(M[Math.floor(Math.random()*M.length)],30+60*(this.gridSize+2),30+60*(i+2)),A[this.gridSize+3][i+2].set(M[Math.floor(Math.random()*M.length)],30+60*(this.gridSize+3),30+60*(i+2));for(i=this.gridSize;i>0;i--)A[i+1][this.gridSize+2].set(M[Math.floor(Math.random()*M.length)],30+60*(i+1),30+60*(this.gridSize+2)),A[i+1][this.gridSize+3].set(M[Math.floor(Math.random()*M.length)],30+60*(i+1),30+60*(this.gridSize+3)),A[1][i+1].set(M[Math.floor(Math.random()*M.length)],90,30+60*(i+1)),A[0][i+1].set(M[Math.floor(Math.random()*M.length)],30,30+60*(i+1))},this.initBoardBalls=function(){for(var i=0;i<this.gridSize;i++)this.spawn();this.enaclick=!0},this.checkNB=function(i,r){var t=A[i][r].color;A[i][r].color="transparent",A[i][r].s=!1,r>2&&A[i][r-1].color==t&&(A[i][r-1].s=!0),r<this.gridSize+1&&A[i][r+1].color==t&&(A[i][r+1].s=!0),i>2&&A[i-1][r].color==t&&(A[i-1][r].s=!0),i<this.gridSize+1&&A[i+1][r].color==t&&(A[i+1][r].s=!0),this.combo++,this.combo>=3&&(this.points+=100+50*(this.combo-3),this.hp=this.hp+1+1*Math.floor(this.gridSize/5),this.hp=this.hp>100?100:this.hp),$("#points").html(this.points)},this.drawCombo=function(){p.clearRect(0,0,d.height,d.width),p.fillStyle=C[F[0]];for(var i=0;i<F.length;i++)p.beginPath(),p.arc(30+60*i,30,25,0,2*Math.PI,!1),p.fill(),p.drawImage(B,60*i,0,60,60)},this.checkColorCombo=function(){if(3==F.length)if(F[0]==F[1]&&F[1]==F[2]){if("red"==F[0]&&(this.hp=this.hp<90?this.hp+=10:this.hp=100),"blue"==F[0]){for(var i=2;i<this.gridSize+1;i++)for(var r=2;r<this.gridSize+1;r++)"blue"==A[i][r].color&&(this.points+=100,A[i][r].s=!0);this.checkGameOver()}if("yellow"==F[0])for(var t=2;t<this.gridSize+1;t++)A[t][0].color="yellow",A[t][this.gridSize+3].color="yellow",A[0][t].color="yellow",A[this.gridSize+3][t].color="yellow";if("green"==F[0])for(var i=2;i<this.gridSize+1;i++)for(var r=2;r<this.gridSize+1;r++)A[i][r].r=30;F=[]}else if(F[1]!=F[2]){var o=F[2];F=[],F.push(o)}if(2==F.length&&F[0]!=F[1]){var o=F[1];F=[],F.push(o)}},this.checkCombo=function(){this.combo=0;for(var i=2;i<this.gridSize+2;i++)for(var r=1,t=2;t<this.gridSize+1;t++)A[t][i].color==A[t+1][i].color&&"transparent"!=A[t][i].color?r++:r=1,3==r&&(A[t][i].s=!0,F.push(A[t][i].color),this.checkColorCombo(),this.drawCombo());for(var t=2;t<this.gridSize+2;t++)for(var r=1,i=2;i<this.gridSize+1;i++)A[t][i].color==A[t][i+1].color&&"transparent"!=A[t][i].color?r++:r=1,3==r&&(A[t][i].s=!0,F.push(A[t][i].color),this.checkColorCombo(),this.drawCombo())},this.drawBoard=function(){f.beginPath(),f.lineWidth=1,f.strokeStyle="black";for(var i=2;i<this.gridSize+3;i++)f.moveTo(60*i,0),f.lineTo(60*i,60*(this.gridSize+4)),f.moveTo(0,60*i),f.lineTo(60*(this.gridSize+4),60*i);f.rect(120,120,60*this.gridSize,60*this.gridSize),f.stroke()},this.handleClick=function(){if(b&&this.enaclick&&(z=setInterval(o,1e3),b=!1,i()),this.enaclick){var r;if(w>1&&w<this.gridSize+2&&m>1&&m<this.gridSize+2){if(m==u&&w>S&&30==A[m][w].r&&"transparent"==A[m][w-1].color){for(r=w-1;"transparent"==A[m][r].color;)r--;r>=2&&r<this.gridSize+1&&(A[m][w].d="up",A[m][w].dx=30+60*m,A[m][w].dy=30+60*(r+1),A[m][w].r=22,this.enaclick=!1)}if(m==u&&S>w&&30==A[m][w].r&&"transparent"==A[m][w+1].color){for(r=w+1;"transparent"==A[m][r].color;)r++;r>2&&r<this.gridSize+2&&(A[m][w].d="down",A[m][w].dx=30+60*m,A[m][w].dy=30+60*(r-1),A[m][w].r=22,this.enaclick=!1)}if(u>m&&w==S&&30==A[m][w].r&&"transparent"==A[m+1][w].color){for(r=m+1;"transparent"==A[r][w].color;)r++;r>2&&r<this.gridSize+2&&(A[m][w].d="right",A[m][w].dx=30+60*(r-1),A[m][w].dy=30+60*w,A[m][w].r=22,this.enaclick=!1)}if(m>u&&w==S&&30==A[m][w].r&&"transparent"==A[m-1][w].color){for(r=m-1;"transparent"==A[r][w].color;)r--;r>=2&&r<this.gridSize+1&&(A[m][w].d="left",A[m][w].dx=30+60*(r+1),A[m][w].dy=30+60*w,A[m][w].r=22,this.enaclick=!1)}}else{if(1==w){for(r=2;"transparent"==A[m][r].color;)r++;r>2&&r<this.gridSize+2&&(A[m][w].d="down",A[m][w].dx=30+60*m,A[m][w].dy=30+60*(r-1),this.enaclick=!1)}if(w==this.gridSize+2){for(r=this.gridSize+1;"transparent"==A[m][r].color;)r--;r>=2&&r<this.gridSize+1&&(A[m][w].d="up",A[m][w].dx=30+60*m,A[m][w].dy=30+60*(r+1),this.enaclick=!1)}if(1==m){for(r=2;"transparent"==A[r][w].color;)r++;r>2&&r<this.gridSize+2&&(A[m][w].d="right",A[m][w].dx=30+60*(r-1),A[m][w].dy=30+60*w,this.enaclick=!1)}if(m==this.gridSize+2){for(r=this.gridSize+1;"transparent"==A[r][w].color;)r--;r>=2&&r<this.gridSize+1&&(A[m][w].d="left",A[m][w].dx=30+60*(r+1),A[m][w].dy=30+60*w,this.enaclick=!1)}}}}}function s(){this.color="transparent",this.s=!1,this.r=30,this.cx=0,this.cy=0,this.d="",this.dx=0,this.dy=0}for(var h=0,a=["ms","moz","webkit","o"],n=0;n<a.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[a[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[n]+"CancelAnimationFrame"]||window[a[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(i){var r=(new Date).getTime(),t=Math.max(0,16-(r-h)),o=window.setTimeout(function(){i(r+t)},t);return h=r+t,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(i){clearTimeout(i)});var c=document.getElementById("board"),d=document.getElementById("board-bg"),l=document.getElementById("combos"),g=c.getContext("2d"),f=d.getContext("2d"),p=l.getContext("2d");$(document).ready(function(){$("#board").height($("#board").width()),$("#board-bg").height($("#board-bg").width()),$("#layers").height($("#board").width()+6),l.width=210,l.height=60,B.src="images/ball.png",B.onload=r}),$(window).on("resize",function(){$("#board").height($("#board").width()),$("#board-bg").height($("#board-bg").width()),$("#layers").height($("#board").width()+6),x=60*(v.gridSize+4)/$("#board").height(),g.clearRect(0,0,c.height,c.width),f.clearRect(0,0,c.height,c.width),v.drawBoard(),v.drawBoardBalls()}),$("#toggle-help").click(function(){help?(clearInterval(z),$("#help").hide(500),v.enaclick=!0):(b=!0,clearInterval(z),$("#help").show(500),v.enaclick=!1),help=!help});var m,w,u,S,z,b,y,v,k,x,M=["red","yellow","blue","green"],C={blue:"#4A89DC",red:"#ED5565",yellow:"#FFCE54",green:"#A0D468",purple:"#AC92EC"},B=new Image,A=new Array,F=new Array;$("#board").on("touchmove",function(i){i.preventDefault()}).on("touchstart",function(i){k=i.originalEvent.touches[0]||i.originalEvent.changedTouches[0],m=Math.floor((k.pageX-$("#board").offset().left)*x/60),w=Math.floor((k.pageY-$("#board").offset().top)*x/60)}).on("touchend",function(i){k=i.originalEvent.touches[0]||i.originalEvent.changedTouches[0],u=Math.floor((k.pageX-$("#board").offset().left)*x/60),S=Math.floor((k.pageY-$("#board").offset().top)*x/60),v.handleClick()}).on("mousedown",function(i){k||(m=Math.floor((i.pageX-$("#board").offset().left)*x/60),w=Math.floor((i.pageY-$("#board").offset().top)*x/60))}).on("mouseup",function(i){k||(u=Math.floor((i.pageX-$("#board").offset().left)*x/60),S=Math.floor((i.pageY-$("#board").offset().top)*x/60),v.handleClick())}),$("#newgame").click(function(){$("#newgame-popup").hide(500),v.points=0,r()}),s.prototype.draw=function(){this.r>3&&(g.beginPath(),g.arc(this.cx,this.cy,this.r-3,0,2*Math.PI,!1),g.fillStyle=C[this.color],g.fill(),g.drawImage(B,this.cx-this.r,this.cy-this.r,2*this.r,2*this.r))},s.prototype.set=function(i,r,t){this.color=i,this.cx=r,this.cy=t},s.prototype.shrink=function(i,r){this.s&&(this.enaclick=!1,this.r>3?this.r-=4:(this.r=3,v.checkNB(i,r)))},s.prototype.move=function(){var i=(this.dx-30)/60,r=(this.dy-30)/60;switch(this.d){case"left":this.cx>this.dx?this.cx=this.cx-v.speed>this.dx?this.cx-v.speed:this.dx:(A[i][r].color=this.color,A[i][r].cx=this.dx,A[i][r].cy=this.dy,A[i][r].r=this.r,this.d="",this.color="transparent",m==v.gridSize+2&&(A[v.gridSize+2][r].color=A[v.gridSize+3][r].color,A[v.gridSize+2][r].cx=30+60*(v.gridSize+2),A[v.gridSize+2][r].cy=30+60*r,A[v.gridSize+3][r].color=M[Math.floor(Math.random()*M.length)]),v.enaclick=!0,v.checkCombo());break;case"right":this.cx<this.dx?this.cx=this.cx+v.speed<this.dx?this.cx+v.speed:this.dx:(A[i][r].color=this.color,A[i][r].cx=this.dx,A[i][r].cy=this.dy,A[i][r].r=this.r,this.d="",this.color="transparent",1==m&&(A[1][r].color=A[0][r].color,A[1][r].cx=90,A[1][r].cy=30+60*r,A[0][r].color=M[Math.floor(Math.random()*M.length)]),v.enaclick=!0,v.checkCombo());break;case"up":this.cy>this.dy?this.cy=this.cy-v.speed>this.dy?this.cy-v.speed:this.dy:(A[i][r].color=this.color,A[i][r].cx=this.dx,A[i][r].cy=this.dy,A[i][r].r=this.r,this.d="",this.color="transparent",w==v.gridSize+2&&(A[i][v.gridSize+2].color=A[i][v.gridSize+3].color,A[i][v.gridSize+2].cx=30+60*i,A[i][v.gridSize+2].cy=30+60*(v.gridSize+2),A[i][v.gridSize+3].color=M[Math.floor(Math.random()*M.length)]),v.enaclick=!0,v.checkCombo());break;case"down":this.cy<this.dy?this.cy=this.cy+v.speed<this.dy?this.cy+v.speed:this.dy:(A[i][r].color=this.color,A[i][r].cx=this.dx,A[i][r].cy=this.dy,A[i][r].r=this.r,this.d="",this.color="transparent",1==w&&(A[i][1].color=A[i][0].color,A[i][1].cx=30+60*i,A[i][1].cy=90,A[i][0].color=M[Math.floor(Math.random()*M.length)]),v.enaclick=!0,v.checkCombo())}}}();